---
import { db, eq, User } from "astro:db"
import { SignIn } from "auth-astro/components"
import { getSession } from "auth-astro/server"
import ProfileHover from "./ProfileHover.astro"

const session = await getSession(Astro.request)
const userUid = crypto.randomUUID()
const username = session?.user?.name
const email = session?.user?.email ?? ""

try {
	if (session?.user) {
		const existingUser = await db.select().from(User).where(eq(User.email, email))

		if (typeof userUid === "string" && typeof username === "string" && typeof email === "string") {
			if (existingUser.length === 0) {
				await db.insert(User).values({
					id: userUid,
					username,
					email,
				})
			}
		}
	}
} catch (e) {
	if (e instanceof Error) {
		console.error("No se pudo guardar el usuario en DB", e.message)
	} else {
		console.error("No se pudo guardar el usuario en DB", e)
	}
}
---

<nav
	class="fixed top-0 z-50 flex w-full items-center justify-between bg-neutral-900/50 px-4 py-4 text-neutral-300 backdrop-blur-md transition-colors duration-300"
>
	<!-- Izquierda: Links de Navegaci贸n -->
	<div class="flex items-center gap-6 md:gap-8">
		<a href="/" class="flex items-center gap-x-2 transition hover:text-white">
			<img src="/favicon-sbg.webp" alt="icon-company" class="h-6 w-6" />
		</a>
		<div class="hidden items-center gap-6 text-sm font-medium sm:flex md:gap-8">
			<a href="/" class="transition hover:text-white"> Inicio </a>
			<a href="/hotels" class="transition hover:text-white"> Hoteles </a>
			<a href="/tours" class="transition hover:text-white"> Tours </a>
			<a href="/packages" class="transition hover:text-white"> Paquetes </a>
			<a href="/dashboard" class="transition hover:text-white"> Dashboard </a>
		</div>
	</div>

	<!-- Derecha: Botones de Publicaci贸n y Sesi贸n -->
	<div class="flex items-center gap-x-4">
		{
			session ? (
				<>
					<ProfileHover />
					<a
						href="/products/create"
						class="flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md transition-colors duration-200 hover:bg-blue-700"
					>
						Publicar
					</a>
				</>
			) : (
				<>
					<SignIn
						provider="google"
						class="hidden items-center justify-center rounded-lg bg-white/10 px-4 py-2 text-sm font-medium text-neutral-200 transition-colors duration-200 hover:bg-white/20 md:flex"
					>
						Ingresar
					</SignIn>
					<SignIn
						id="fixedSessionPost"
						provider="google"
						class="flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-md transition-colors duration-200 hover:bg-blue-700"
					>
						Publicar
					</SignIn>
				</>
			)
		}
	</div>
</nav>
<div class="absolute top-9 h-2 w-full bg-white"></div>

<script>
	// Script para ocultar/mostrar la barra de navegaci贸n al hacer scroll
	let lastScrollY = window.scrollY
	const nav = document.querySelector("nav")

	const handleScroll = () => {
		const currentScrollY = window.scrollY
		if (lastScrollY < currentScrollY && currentScrollY > 50) {
			nav?.classList.add("-translate-y-full")
		} else {
			nav?.classList.remove("-translate-y-full")
		}
		lastScrollY = currentScrollY
	}

	window.addEventListener("scroll", handleScroll)
</script>
