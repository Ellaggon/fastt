---
import Layout from "@/layouts/Layout.astro"
import { db, eq, Provider } from "astro:db"
import { getSession } from "auth-astro/server"

const session = await getSession(Astro.request)
if (!session) return Astro.redirect("/SignInPage") // Unificar el check de sesión y redirección.

// Buscar si ya existe un proveedor registrado con este email
const existing = await db
	.select()
	.from(Provider)
	.where(eq(Provider.userEmail, session.user?.email || ""))
	.get()

if (existing) return Astro.redirect("/dashboard")
---

<Layout title="Registrar Proveedor">
	<article
		class="mx-auto mt-20 w-10/12 rounded-2xl border border-neutral-300 bg-neutral-200 p-8 text-neutral-800 shadow-lg sm:p-10 md:max-w-lg lg:max-w-2xl lg:p-20"
	>
		<h2 class="mb-2 text-2xl font-semibold">REGISTRAR MI EMPRESA</h2>
		<p class="mb-8 text-xs text-neutral-500">
			Ingresa los datos de tu empresa para empezar a publicar tus servicios.
		</p>
		<form id="providerForm" method="post" class="flex flex-col gap-4" data-form-type="provider">
			{/* */}
			<input type="hidden" name="userEmail" value={session.user?.email} />

			{/* */}
			<label for="companyName" class="block text-xs font-medium text-neutral-500 md:text-sm">
				Nombre de la Compañía
				<input
					type="text"
					id="companyName"
					name="companyName"
					placeholder="Ej: Hotel del Mar S.A."
					class="mt-2 block w-full rounded-lg border-transparent bg-neutral-100 px-4 py-3 text-neutral-800 placeholder-neutral-400 shadow-sm transition-colors duration-200 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm"
					required
				/>
			</label>

			{/* */}
			<label for="contactName" class="block text-xs font-medium text-neutral-500 md:text-sm">
				Nombre de Contacto
				<input
					type="text"
					id="contactName"
					name="contactName"
					placeholder="Ej: Juan Pérez"
					class="mt-2 block w-full rounded-lg border-transparent bg-neutral-100 px-4 py-3 text-neutral-800 placeholder-neutral-400 shadow-sm transition-colors duration-200 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm"
					required
				/>
			</label>

			{/* */}
			<label for="contactEmail" class="block text-xs font-medium text-neutral-500 md:text-sm">
				Email de Contacto
				<input
					type="email"
					id="contactEmail"
					name="contactEmail"
					placeholder="ejemplo@empresa.com"
					class="mt-2 block w-full rounded-lg border-transparent bg-neutral-100 px-4 py-3 text-neutral-800 placeholder-neutral-400 shadow-sm transition-colors duration-200 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm"
					required
				/>
			</label>

			{/* */}
			<label for="phone" class="block text-xs font-medium text-neutral-500 md:text-sm">
				Teléfono
				<input
					type="tel"
					id="phone"
					name="phone"
					placeholder="Ej: +56 9 1234 5678"
					class="mt-2 block w-full rounded-lg border-transparent bg-neutral-100 px-4 py-3 text-neutral-800 placeholder-neutral-400 shadow-sm transition-colors duration-200 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm"
				/>
			</label>

			{/* */}
			<label for="type" class="block text-xs font-medium text-neutral-500 md:text-sm">
				Tipo de Proveedor
				<select
					name="type"
					id="type"
					class="mt-2 block w-full cursor-pointer rounded-lg border-transparent bg-neutral-100 px-4 py-3 text-sm font-medium text-neutral-800 shadow-sm transition-colors duration-200 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500"
					required
				>
					<option value="">Selecciona un tipo...</option>
					<option value="Hotel">Hotel</option>
					<option value="Tour Operator">Tour Operator</option>
					<option value="Transport">Transporte</option>
					<option value="Restaurant">Restaurante</option>
				</select>
			</label>

			<div class="mt-10 flex justify-end">
				<button
					type="submit"
					class="h-10 w-40 rounded-lg bg-blue-600 px-4 py-1 font-medium text-white shadow-md transition-colors duration-200 hover:bg-blue-700"
				>
					Registrarme
				</button>
			</div>
		</form>
	</article>

	<script src="/src/lib/forms/formHandler"></script>
</Layout>
