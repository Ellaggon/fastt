---
import Layout from "@/layouts/Layout.astro"
import { getProductWithImagesAndSubtype } from "@/lib/db/product"
import { getProviderIdFromRequest } from "@/lib/db/provider"
import { getSession } from "auth-astro/server"

const session = await getSession(Astro.request)
const paramsId = Astro.params.id

if (!session?.user?.email) return Astro.redirect("/SignInPage")
if (!paramsId) return Astro.redirect("/dashboard")

const providerId = await getProviderIdFromRequest(Astro.request)
if (!providerId) return Astro.redirect("/forms/provider")

const productBundle = await getProductWithImagesAndSubtype(paramsId)
if (!productBundle) return Astro.redirect("/dashboard")

if (String(productBundle.product.providerId) !== String(providerId)) {
	return Astro.redirect("/dashboard")
}

const product = productBundle.product
const images = productBundle.images || [] // [{id, url, order, isPrimary, ...}]

const safeInitialImages = JSON.stringify(images || []).replace(/<\/script>/g, "<\\/script>")
---

<Layout title={`Editar Imágenes · ${product.id} `}>
	<div
		class="mx-auto mt-16 w-11/12 max-w-4xl rounded-2xl border border-neutral-300 bg-neutral-100/80 p-8 shadow-lg backdrop-blur-md sm:p-10 lg:p-16"
	>
		<h1 class="mb-6 text-2xl font-bold text-neutral-800 lg:text-3xl">
			Editar Imágenes de <span class="text-blue-600">{product.name}</span>
		</h1>

		<!-- Zona de drop/upload -->
		<div
			id="dropZone-product"
			class="flex flex-col items-center justify-center rounded-2xl border-2 border-dashed border-neutral-400 bg-white/70 p-10 text-center shadow-inner transition-colors duration-200 hover:border-blue-500 hover:bg-blue-50/70"
		>
			<p id="imageText-product" class="mb-4 text-sm text-neutral-500">
				Haz clic o arrastra imágenes aquí
			</p>
			<input
				id="imageUpload-product"
				name="imageUpload-product"
				type="file"
				accept="image/*"
				multiple
				class="hidden"
			/>
			<button
				id="pickBtn"
				class="rounded-lg bg-blue-600 px-6 py-2 text-white shadow-sm transition hover:bg-blue-700"
			>
				Seleccionar imágenes
			</button>
		</div>

		<input type="hidden" id="productId" value={product.id} />
		<!-- Previsualización en grid -->
		<script id="initialImages" type="application/json" set:html={safeInitialImages} />

		<div id="imagePreview" class="mt-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>

		<span class="error mt-4 block text-sm text-red-500" data-error-for="imagesMeta"></span>

		<!-- Acciones -->
		<div class="mt-10 flex justify-end gap-4">
			<button
				id="cancelBtn"
				class="rounded-lg border border-neutral-400 bg-white px-5 py-2 text-sm font-medium text-neutral-700 shadow-sm transition hover:bg-neutral-100"
			>
				Cancelar
			</button>
			<button
				id="saveBtn"
				class="rounded-lg bg-blue-600 px-6 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700"
			>
				Guardar cambios
			</button>
		</div>
	</div>

	<script src="/src/lib/forms/imageFormHandler.ts"></script>
</Layout>
