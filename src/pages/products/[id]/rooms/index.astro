---
import RoomModals from "@/components/productForm/RoomModals.astro"
import { AMENITY_ROOMS } from "@/data/room-amenity"
import Layout from "@/layouts/Layout.astro"
import { db, eq, Product } from "astro:db"
import { getSession } from "auth-astro/server"

const hotelId = Astro.params.id
const session = await getSession(Astro.request)
if (!session) return Astro.redirect("/SignInPage")

let hotelDetails
if (hotelId) {
	hotelDetails = await db.select().from(Product).where(eq(Product.id, hotelId)).get()
}
---

<Layout title="Configurar Habitaciones">
	<section class="h-full w-full pt-10 md:pt-16">
		<article
			class="mx-auto w-[98%] rounded-3xl bg-neutral-200 p-8 text-neutral-800 shadow-lg backdrop-blur-md sm:p-10 md:w-[80%] lg:max-w-4xl lg:p-20"
		>
			<h2 class="text-lg font-bold md:mb-1 md:text-2xl lg:text-3xl">
				CONFIGURACIÓN DE HABITACIONES
			</h2>
			<p class="mb-8 text-sm text-neutral-500">Define precios, inventario y detalles por tipo.</p>

			{
				hotelDetails && (
					<p class="mb-6 text-end text-base text-neutral-600">
						<span class="font-semibold">{hotelDetails.name}</span>
					</p>
				)
			}

			<form id="hotelRoomTypeForm" enctype="multipart/form-data" class="space-y-10">
				<input id="hotelId" type="hidden" name="hotelId" value={hotelId} />

				<section class="space-y-6 rounded-2xl border border-neutral-300 p-6 shadow-sm">
					<h3 class="text-lg font-semibold text-neutral-800">Información General</h3>

					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Tipo de habitación</span>
							<button
								id="openRoomTypeModal"
								type="button"
								class="mt-1 rounded-xl border border-neutral-300 bg-neutral-100 px-3 py-3 text-left text-neutral-800"
							>
								Seleccionar tipo de habitación
							</button>
							<input type="hidden" name="roomTypeId" id="roomTypeId" />
						</label>
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Tipo de cama</span>
							<button
								id="openBedTypeModal"
								type="button"
								class="mt-1 rounded-xl border border-neutral-300 bg-neutral-100 px-3 py-3 text-left text-neutral-800"
							>
								Selecciona tipos de cama
							</button>
							<input type="hidden" name="bedTypes" id="bedTypes" />
						</label>
					</div>

					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Nombre comercial</span>
							<input name="name" type="text" class="mt-1 rounded-md bg-neutral-100 px-3 py-2" />
						</label>
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Capacidad máxima</span>
							<input
								type="number"
								name="maxOccupancy"
								min="1"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>
					</div>
					<label class="flex flex-col text-sm">
						<span class="text-neutral-600">Descripción</span>
						<textarea name="description" rows="2" class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
						></textarea>
					</label>
				</section>

				<section class="space-y-6 rounded-2xl border border-neutral-300 p-6 shadow-sm">
					<h3 class="text-lg font-semibold text-neutral-800">Características</h3>

					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Tamaño de la habitación (m²)</span>
							<input
								type="number"
								name="sizeM2"
								min="0"
								step="0.1"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>

						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Cantidad de baños</span>
							<input
								type="number"
								name="bathroom"
								min="0"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>
					</div>

					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Total de habitaciones (inventario)</span>
							<input
								type="number"
								name="totalRooms"
								min="0"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>

						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Vista</span>
							<input
								name="hasView"
								placeholder="Ej: a la ciudad"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>
					</div>

					<label class="flex items-center space-x-3 pt-2">
						<input
							type="checkbox"
							name="hasBalcony"
							value="1"
							class="h-4 w-4 rounded border-neutral-300 bg-neutral-100"
						/>
						<span class="text-sm text-neutral-700">Incluye balcón</span>
					</label>
				</section>

				<section class="space-y-6 rounded-2xl border border-neutral-300 p-6 shadow-sm">
					<h3 class="text-lg font-semibold text-neutral-800">Precio Base</h3>

					<div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Precio base USD</span>
							<input
								type="number"
								name="basePriceUSD"
								value="0"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>

						<label class="flex flex-col text-sm">
							<span class="text-neutral-600">Precio base BOB</span>
							<input
								type="number"
								name="basePriceBOB"
								value="0"
								class="mt-1 rounded-md bg-neutral-100 px-3 py-2"
							/>
						</label>
					</div>
				</section>

				<section class="rounded-2xl border border-neutral-300 bg-neutral-200 p-6 shadow-sm">
					<h3 class="mb-4 text-lg font-semibold text-neutral-800">Amenities</h3>

					<div class="grid grid-cols-2 gap-3 text-sm sm:grid-cols-3 lg:grid-cols-4">
						{
							AMENITY_ROOMS.map((a) => (
								<label class="flex items-center space-x-2 text-neutral-700">
									<input
										type="checkbox"
										name="amenities"
										value={a.id}
										class="h-4 w-4 rounded border-neutral-300 bg-neutral-100"
									/>
									<span>{a.name}</span>
								</label>
							))
						}
					</div>
				</section>

				<section class="rounded-2xl border border-neutral-300 p-6 shadow-sm">
					<h3 class="mb-3 text-lg font-semibold text-neutral-800">Imágenes</h3>

					<input
						id="roomImages"
						name="roomImages"
						type="file"
						accept="image/*"
						multiple
						class="w-full rounded-md bg-neutral-100 px-3 py-2 file:mr-4 file:rounded-full file:border-0 file:bg-neutral-300 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-neutral-700 hover:file:bg-neutral-400"
					/>
				</section>

				<div class="flex justify-end">
					<button
						type="submit"
						class="h-12 w-48 rounded-xl bg-blue-600 font-medium text-white shadow-md hover:bg-blue-700"
					>
						Guardar habitación
					</button>
				</div>
			</form>
		</article>
		<div
			id="roomTypeModal"
			class="modal fixed inset-0 flex hidden items-center justify-center"
			style="background: rgba(0, 0, 0, 0.45)"
		>
			<div
				class="modal-content items-between flex max-h-[85vh] w-[97%] flex-col overflow-y-auto rounded-3xl bg-neutral-100 px-[20px] pt-10 md:h-[80%] md:w-[600px] md:pt-0"
			>
				<h3 class="border-b border-neutral-200 py-4 text-sm text-neutral-800 md:text-base">
					Selecciona un tipo de habitación
				</h3>
				<ul id="roomTypeList" class="my-10"></ul>

				<div class="border-t border-neutral-200 py-4 text-center text-sm text-black">
					<button type="button" class="closeModal">Cerrar</button>
				</div>
			</div>
		</div>

		<div
			id="bedTypeModal"
			class="modal fixed inset-0 flex hidden items-center justify-center"
			style="background: rgba(0, 0, 0, 0.45)"
		>
			<div
				class="modal-content items-between flex max-h-[85vh] w-[97%] flex-col overflow-y-auto rounded-3xl bg-neutral-100 px-[20px] pt-10 md:h-[80%] md:w-[600px]"
			>
				<h3 class="border-b border-neutral-200 py-4 text-sm text-neutral-800 md:text-base">
					Selecciona tipos de cama
				</h3>
				<ul id="bedTypeList" class="my-10"></ul>

				<div class="mt-auto flex justify-end gap-6 border-t border-neutral-200 py-4 text-sm">
					<button type="button" class="closeModal text-black">Cerrar</button>
					<button id="saveBedTypes" class="rounded-xl bg-neutral-800 px-4 py-2 text-white"
						>Guardar selección</button
					>
				</div>
			</div>
		</div>
		<RoomModals />
	</section>

	<script type="module" src="/src/lib/forms/roomFormHandler"></script>
</Layout>
