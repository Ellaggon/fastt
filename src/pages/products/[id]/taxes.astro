---
import Layout from "@/layouts/Layout.astro"
---

<Layout title="Taxes & Fees">
	<main
		class="mx-auto mt-20 w-[95%] max-w-3xl rounded-3xl border border-neutral-300 bg-neutral-200 p-8 text-neutral-800 shadow-lg md:p-12 lg:p-16"
	>
		<h1 class="text-xl font-semibold md:text-2xl">IMPUESTOS Y TARIFAS</h1>
		<p class="mt-1 text-sm text-neutral-500">Configura impuestos y cargos aplicados al producto.</p>

		<div class="mt-6 flex justify-end">
			<button
				id="btnAdd"
				class="rounded-xl bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700"
			>
				+ Agregar
			</button>
		</div>

		<div id="taxList" class="mt-8 space-y-4 text-neutral-700">Cargando...</div>

		<!-- MODAL -->
		<dialog
			id="taxModal"
			class="w-[90%] max-w-md rounded-2xl border border-neutral-300 bg-neutral-100 p-6 shadow-xl"
		>
			<h3 id="modalTitle" class="mb-4 text-lg font-semibold text-neutral-800"></h3>

			<form id="taxForm" class="space-y-4">
				<input type="hidden" id="taxId" />

				<div>
					<label class="text-sm font-medium">Nombre</label>
					<input id="taxName" class="w-full rounded-xl border px-3 py-2" />
				</div>

				<div>
					<label class="text-sm font-medium">Tipo</label>
					<select id="taxType" class="w-full rounded-xl border px-3 py-2">
						<option value="percentage">Porcentaje</option>
						<option value="fixed">Monto fijo</option>
						<option value="perPerson">Por persona</option>
						<option value="perNight">Por noche</option>
						<option value="perBooking">Por reserva</option>
					</select>
				</div>

				<div>
					<label class="text-sm font-medium">Valor</label>
					<input type="number" id="taxValue" class="w-full rounded-xl border px-3 py-2" />
				</div>

				<div>
					<label class="text-sm font-medium">Moneda</label>
					<select id="taxCurrency" class="w-full rounded-xl border px-3 py-2">
						<option value="BOB">BOB</option>
						<option value="USD">USD</option>
					</select>
				</div>

				<label class="flex items-center gap-2 text-sm">
					<input type="checkbox" id="taxIncluded" />
					<span>Incluido en el precio</span>
				</label>

				<label class="flex items-center gap-2 text-sm">
					<input type="checkbox" id="taxActive" checked />
					<span>Activo</span>
				</label>

				<div class="mt-6 flex justify-end gap-3">
					<button type="button" id="btnCancel" class="rounded-xl border bg-white px-4 py-2 text-sm"
						>Cancelar</button
					>

					<button
						type="submit"
						class="rounded-xl bg-blue-600 px-5 py-2 text-sm font-semibold text-white"
					>
						Guardar
					</button>
				</div>
			</form>
		</dialog>
	</main>

	<script type="module">
		const productId = window.location.pathname.split("/")[2]

		const list = document.getElementById("taxList")
		const modal = document.getElementById("taxModal")
		const form = document.getElementById("taxForm")

		const idInput = document.getElementById("taxId")
		const nameInput = document.getElementById("taxName")
		const typeInput = document.getElementById("taxType")
		const valueInput = document.getElementById("taxValue")
		const currencyInput = document.getElementById("taxCurrency")
		const includedInput = document.getElementById("taxIncluded")
		const activeInput = document.getElementById("taxActive")
		const title = document.getElementById("modalTitle")

		document.getElementById("btnAdd").onclick = () => {
			idInput.value = ""
			nameInput.value = ""
			typeInput.value = "percentage"
			valueInput.value = ""
			currencyInput.value = "BOB"
			includedInput.checked = false
			activeInput.checked = true
			title.textContent = "Nuevo impuesto / tarifa"
			modal.showModal()
		}

		document.getElementById("btnCancel").onclick = () => modal.close()

		form.onsubmit = async (e) => {
			e.preventDefault()

			const id = idInput.value
			const url = id
				? `/api/products/${productId}/taxes/${id}/update`
				: `/api/products/${productId}/taxes/create`

			await fetch(url, {
				method: id ? "PUT" : "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					name: nameInput.value,
					type: typeInput.value,
					value: Number(valueInput.value),
					currency: currencyInput.value,
					isIncluded: includedInput.checked,
					isActive: activeInput.checked,
				}),
			})

			modal.close()
			loadTaxes()
		}

		async function loadTaxes() {
			list.innerHTML = "Cargando..."

			const res = await fetch(`/api/products/${productId}/taxes/get`)
			const data = await res.json()

			if (!data.taxes?.length) {
				list.innerHTML = `<p class="text-neutral-500">No hay impuestos aún.</p>`
				return
			}

			list.innerHTML = data.taxes
				.map(
					(t) => `
          <div class="p-4 bg-white border rounded-xl shadow flex justify-between">
            <div>
              <p class="font-semibold">${t.name} — ${t.type}</p>
              <p class="text-neutral-600 text-sm">Valor: ${t.value} ${t.currency}</p>
              <p class="text-xs ${t.isActive ? "text-green-600" : "text-red-600"}">
                ${t.isActive ? "Activo" : "Inactivo"}
              </p>
            </div>

            <div class="flex gap-3">
              <button 
                class="btnEdit"
                data-id="${t.id}"
                data-name="${t.name}"
                data-type="${t.type}"
                data-value="${t.value}"
                data-currency="${t.currency}"
                data-included="${t.isIncluded}"
                data-active="${t.isActive}"
              >Editar</button>

              <button class="btnDelete text-red-600" data-id="${t.id}">Eliminar</button>
            </div>
          </div>
        `
				)
				.join("")

			list.querySelectorAll(".btnEdit").forEach((btn) => {
				btn.onclick = () => {
					idInput.value = btn.dataset.id
					nameInput.value = btn.dataset.name
					typeInput.value = btn.dataset.type
					valueInput.value = btn.dataset.value
					currencyInput.value = btn.dataset.currency
					includedInput.checked = btn.dataset.included === "true"
					activeInput.checked = btn.dataset.active === "true"
					title.textContent = "Editar impuesto / tarifa"
					modal.showModal()
				}
			})

			list.querySelectorAll(".btnDelete").forEach((btn) => {
				btn.onclick = () => removeTax(btn.dataset.id)
			})
		}

		window.removeTax = async (id) => {
			if (!confirm("¿Eliminar?")) return

			await fetch(`/api/products/${productId}/taxes/${id}/delete`, {
				method: "DELETE",
			})

			loadTaxes()
		}

		loadTaxes()
	</script>
</Layout>
