---
import HotelForm from "@/components/product/subtypes/HotelForm.astro"
import PackageForm from "@/components/product/subtypes/PackageForm.astro"
import TourForm from "@/components/product/subtypes/TourForm.astro"
import Layout from "@/layouts/Layout.astro"
import { getProductWithImagesAndSubtype } from "@/lib/db/product"
import { getProviderIdFromRequest } from "@/lib/db/provider"
import { getSession } from "auth-astro/server"

const session = await getSession(Astro.request)
const paramsId = Astro.params.id

// redirecciones / checks
const providerId = await getProviderIdFromRequest(Astro.request)
if (!providerId) return Astro.redirect("/provider")

// obtener provider
if (!session?.user?.email) return Astro.redirect("/SignInPage")
if (!paramsId) return Astro.redirect("/dashboard")

const productBundle = await getProductWithImagesAndSubtype(paramsId)
if (!productBundle) return Astro.redirect("/dashboard")

// verificar product pertenece al provider
if (String(productBundle.product.providerId) !== String(providerId)) {
	return Astro.redirect("/dashboard")
}

const product = productBundle.product
const subtype = (product.productType || "hotel").toLowerCase()
---

<Layout title={`Detalles: ${product.name || "Producto"}`}>
	<article
		class="mx-auto mt-20 w-10/12 max-w-3xl rounded-2xl bg-neutral-200 p-8 text-neutral-800 shadow-lg sm:p-10 md:max-w-lg lg:max-w-2xl lg:p-20"
	>
		<h2 class="mb-2 text-2xl font-bold">Detalles adicionales — {product.name}</h2>
		<p class="mb-8 text-xs text-neutral-500">
			Completa la información específica para tu {subtype === "package" ? "Paquete" : subtype}.
		</p>

		<form id="subtypeForm" class="space-y-4">
			<input type="hidden" name="productId" value={paramsId} />
			<input type="hidden" name="subtype" value={subtype} />

			<div class={subtype !== "hotel" ? "hidden" : ""}><HotelForm productId={paramsId} /></div>
			<div class={subtype !== "tour" ? "hidden" : ""}><TourForm productId={paramsId} /></div>
			<div class={subtype !== "package" ? "hidden" : ""}><PackageForm productId={paramsId} /></div>

			<div class="flex justify-end pt-4">
				<button
					id="submitBtn"
					type="button"
					class="h-10 w-40 rounded-lg bg-blue-600 px-4 py-1 font-medium text-white shadow-md transition-colors duration-200 hover:bg-blue-700"
					>Guardar detalles</button
				>
			</div>
		</form>

		<div id="message" class="mt-4 text-sm"></div>
	</article>

	<script type="module">
		const form = document.getElementById("subtypeForm")
		const btn = document.getElementById("submitBtn")
		const message = document.getElementById("message")

		btn.addEventListener("click", async () => {
			btn.disabled = true
			btn.textContent = "Guardando..."
			message.textContent = ""

			const fd = new FormData(form)
			try {
				const res = await fetch("/api/products/subtype/create", {
					method: "POST",
					body: fd,
					credentials: "same-origin",
				})

				if (!res.ok) {
					let json = {}
					try {
						json = await res.json()
					} catch (e) {}
					const err = json?.error ? JSON.stringify(json.error) : res.statusText
					message.textContent = "Error: " + err
					btn.disabled = false
					btn.textContent = "Guardar detalles"
					return
				}

				// success -> redirect to product detail
				window.location.href = `/dashboard`
			} catch (e) {
				console.error(e)
				message.textContent = "Error de red. Intenta nuevamente."
				btn.disabled = false
				btn.textContent = "Guardar detalles"
			}
		})
	</script>
</Layout>
