---
import Layout from "@/layouts/Layout.astro"
import SignInPage from "@/pages/SignInPage.astro"
import { db, eq, User } from "astro:db"
import { getSession } from "auth-astro/server"

const session = await getSession(Astro.request)
let providerId = ""

// Si hay una sesión activa, busca el usuario y su providerId
if (session?.user?.email) {
	const user = await db.select().from(User).where(eq(User.email, session.user.email)).get()
	console.log(user)
	if (user?.providerId) {
		providerId = user.providerId
		console.log(`providerId de ${session?.user?.name}: `, providerId)
	} else {
		console.error("No se encontró providerId para el usuario:", session.user.email)
	}
}
---

<Layout title="Crear Nuevo Producto">
	{
		session ? (
			<article class="mx-auto w-10/12 rounded-lg bg-beaver-900 p-8 text-gray-300 sm:p-10 md:max-w-lg lg:max-w-2xl lg:p-20">
				<h2 class="mb-4 text-2xl font-semibold">CREAR NUEVO PRODUCTO</h2>
				<p class="mb-6 text-xs text-gray-400">Ingresa la información básica de tu producto.</p>

				<form id="productForm" method="post" class="flex flex-col gap-4" data-form-type="product">
					<input type="hidden" name="providerId" value={providerId} />

					<label for="name" class="block text-xs font-medium text-gray-400 md:text-sm">
						Nombre del Producto
						<input
							type="text"
							id="name"
							name="name"
							placeholder="Ej: Tour al Salar de Uyuni"
							class="mt-1 block w-full rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-white shadow-sm focus:border-green-150 focus:outline-none focus:ring-green-150 sm:text-sm"
							required
						/>
						<span class="error mt-1 text-sm text-red-500" data-error-for="name" />
					</label>

					<label for="productType" class="block text-xs font-medium text-gray-400 md:text-sm">
						Tipo de Producto
						<select
							name="productType"
							id="productType"
							class="mt-1 block w-full cursor-pointer rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm font-medium shadow-sm focus:border-green-150 focus:outline-none focus:ring-green-150"
							required
						>
							<option value="">Selecciona un tipo...</option>
							<option value="Hotel">Hotel</option>
							<option value="Tour">Tour</option>
							<option value="Package">Paquete</option>
						</select>
						<span class="error mt-1 text-sm text-red-500" data-error-for="productType" />
					</label>

					<label for="shortDescription" class="block text-xs font-medium text-gray-400 md:text-sm">
						Descripción Corta
						<textarea
							name="shortDescription"
							id="shortDescription"
							rows="2"
							placeholder="Resumen del producto en una frase"
							class="mt-1 block w-full rounded border border-gray-600 bg-gray-700 px-3 py-2 text-white focus:border-green-150 focus:outline-none focus:ring-green-150 sm:text-sm"
						/>
						<span class="error mt-1 text-sm text-red-500" data-error-for="shortDescription" />
					</label>

					<label for="longDescription" class="block text-xs font-medium text-gray-400 md:text-sm">
						Descripción Completa
						<textarea
							name="longDescription"
							id="longDescription"
							rows="5"
							placeholder="Describe los detalles completos del producto"
							class="mt-1 block w-full rounded border border-gray-600 bg-gray-700 px-3 py-2 text-white focus:border-green-150 focus:outline-none focus:ring-green-150 sm:text-sm"
						/>
						<span class="error mt-1 text-sm text-red-500" data-error-for="longDescription" />
					</label>

					<label class="block text-xs font-medium text-gray-400 md:text-sm">
						Ciudad
						<select
							name="cityId"
							id="cityId"
							class="mt-1 block w-full cursor-pointer rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm font-medium shadow-sm focus:border-green-150 focus:outline-none focus:ring-green-150"
							required
						>
							<option value="">Selecciona una ciudad...</option>
							<option value="uuid-city-lapaz">La Paz</option>
							<option value="uuid-city-santacruz">Santa Cruz</option>
							<option value="uuid-city-cochabamba">Cochabamba</option>
							<option value="uuid-city-oruro">Oruro</option>
							<option value="uuid-city-potosi">Potosí</option>
							<option value="uuid-city-sucre">Sucre</option>
							<option value="uuid-city-tarija">Tarija</option>
							<option value="uuid-city-trinidad">Trinidad</option>
							<option value="uuid-city-cobija">Cobija</option>
						</select>
						<span class="error mt-1 text-sm text-red-500" data-error-for="cityId" />
					</label>

					<label for="basePriceUSD" class="block text-xs font-medium text-gray-400 md:text-sm">
						Precio Base (USD)
						<input
							type="number"
							id="basePriceUSD"
							name="basePriceUSD"
							placeholder="Precio en dólares"
							class="mt-1 block w-full rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-white shadow-sm focus:border-green-150 focus:outline-none focus:ring-green-150 sm:text-sm"
							required
						/>
						<span class="error mt-1 text-sm text-red-500" data-error-for="basePriceUSD" />
					</label>

					<label for="basePriceBOB" class="block text-xs font-medium text-gray-400 md:text-sm">
						Precio Base (BOB)
						<input
							type="number"
							id="basePriceBOB"
							name="basePriceBOB"
							placeholder="Precio en bolivianos"
							class="mt-1 block w-full rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-white shadow-sm focus:border-green-150 focus:outline-none focus:ring-green-150 sm:text-sm"
							required
						/>
						<span class="error mt-1 text-sm text-red-500" data-error-for="basePriceBOB" />
					</label>

					{/* Subida de imágenes (IDs únicos) */}
					<div class="relative">
						<label
							for="imageUpload-product"
							class="block text-xs font-medium text-gray-400 md:text-sm"
						>
							Imágenes del producto
						</label>
						<div
							id="dropZone-product"
							class="dropZone mt-2 flex min-h-64 w-full cursor-pointer flex-col items-center justify-center overflow-auto rounded-lg border border-gray-700 bg-gray-900 text-center"
						>
							<p id="imageText-product" class="flex flex-col gap-2 text-xs md:text-sm">
								<span>Arrastra y suelta o haz click</span>
							</p>
							<input
								type="file"
								class="hidden"
								id="imageUpload-product"
								name="imageUpload-product"
								accept="image/*"
								multiple
							/>
							{/* <div id="imagePreview-product" class="hidden gap-3 sm:m-6" /> */}
							<div id="imagePreview" class="flex flex-wrap gap-2" />
						</div>
						<span class="error mt-3 text-sm text-red-500" data-error-for="imagesMeta" />
					</div>

					<div class="mt-10 flex justify-end">
						<button
							type="submit"
							class="h-10 w-40 rounded-lg bg-white p-1 text-black hover:bg-green-150 hover:text-lg"
						>
							Siguiente
						</button>
					</div>
				</form>
			</article>
		) : (
			<div class="flex items-center justify-center">
				<SignInPage />
			</div>
		)
	}
</Layout>

<script src="/src/lib/forms/productFormHandler"></script>
