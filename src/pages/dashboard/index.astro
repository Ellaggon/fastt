---
import Layout from "@/layouts/Layout.astro"
import { getProductsByProvider } from "@/lib/db/product"
import { getProviderIdFromRequest } from "@/lib/db/provider"
import { db, HotelRoomType, inArray } from "astro:db"
import { getSession } from "auth-astro/server"

const session = await getSession(Astro.request)

let userProducts: any[] = []
let hotelRoomTypes: any[] = []
let roomsByHotel: Record<string, any[]> = {}
let errorMessage: string | null = null

try {
	if (!session?.user?.email) {
		return Astro.redirect("/SignInPage")
	}
	const providerId = await getProviderIdFromRequest(Astro.request)
	if (!providerId) {
		return Astro.redirect("/provider")
	}

	userProducts = await getProductsByProvider(providerId)

	const hotelIds = userProducts.filter((el) => el.productType === "Hotel").map((el) => el.id)

	if (hotelIds.length > 0) {
		hotelRoomTypes = await db
			.select()
			.from(HotelRoomType)
			.where(inArray(HotelRoomType.hotelId, hotelIds))

		for (const room of hotelRoomTypes) {
			if (!roomsByHotel[room.hotelId]) roomsByHotel[room.hotelId] = []
			roomsByHotel[room.hotelId].push(room)
		}
	}
	console.log("userProducts: ", userProducts)
} catch (e) {
	console.error("Error al obtener los productos del proveedor: ", e)
	errorMessage = "Hubo un error al cargar los productos. Por favor, inténtalo de nuevo más tarde."
}
---

<Layout title="Panel del Proveedor">
	<div
		class="mx-auto flex w-full max-w-7xl items-center justify-center pb-24 pt-10 md:flex-col md:pt-20"
	>
		<navbar class="mb-8 hidden w-[90%] items-center justify-between md:mb-12 md:flex">
			<h2 class="text-xl font-semibold text-neutral-100 lg:text-4xl lg:font-extrabold">
				Panel del Proveedor
			</h2>
			<a
				href="/products/create"
				class="transform gap-2 rounded-2xl bg-neutral-800 px-3 py-1 font-semibold text-white shadow-md transition-transform hover:scale-105 md:px-6 md:py-2"
			>
				Crea un Nuevo Producto
			</a>
		</navbar>

		<main class="w-[98%] rounded-3xl bg-beaver-900 p-3 shadow-lg md:p-8">
			<article
				class="flex h-auto w-full cursor-pointer gap-3 border-b border-neutral-700 text-sm text-neutral-400"
				id="tabs"
			>
				<div class="tab-button active p-2 text-white" data-tab="products">Productos</div>
				<div class="tab-button p-2" data-tab="edit">Editar Productos</div>
				<div class="tab-button p-2" data-tab="room">Configurar Habitaciones</div>
			</article>
			<div class="mx-auto">
				{
					errorMessage ? (
						<div class="border-l-4 border-red-500 bg-red-100 p-4 text-red-700" role="alert">
							<p class="font-bold">Error</p>
							<p>{errorMessage}</p>
						</div>
					) : userProducts.length === 0 ? (
						<div>
							<p class="mb-4 text-lg">Aún no has creado nungún tour o paquete.</p>
							<p class="text-sm">
								Haz clic en el boton "Crear Nuevo Producto" para empezar a vender.
							</p>
						</div>
					) : (
						<section class="overflow-x-auto">
							<div class="rounded-lg bg-beaver-900 p-1 shadow-lg md:p-6">
								<article class="mb-4 hidden items-center justify-between md:flex">
									<h3 class="text-lg font-semibold">Tus productos</h3>
									<p class="text-sm text-neutral-400">{userProducts.length} en total</p>
								</article>

								{/* <!-- Contenido de Productos --> */}
								<article
									id="tab-products"
									class="tab-content translate-y-0 divide-y divide-neutral-800 opacity-100 transition-all duration-300 md:mt-4"
								>
									{userProducts.map((el) => {
										let type = null
										if (el.productType === "Hotel") type = "hotels"
										if (el.productType === "Tour") type = "tours"
										if (el.productType === "Package") type = "packages"
										return (
											<div class="items-center justify-between py-3 md:flex">
												<div class="mb-3 flex flex-col">
													<a href={`/${type}/${el.id}`}>
														<span class="text-xs font-medium text-neutral-100 md:text-sm">
															{el.name}
														</span>
													</a>
													<span class="hidden text-xs text-neutral-400 md:block">
														{el.productType}
													</span>
													<small class="text-xs text-neutral-400 md:hidden">{el.productType}</small>
												</div>

												<div class="flex items-center justify-end gap-6 text-xs font-medium md:text-sm">
													<a
														href={`/products/${el.id}/edit/services`}
														class="text-green-400 hover:text-green-300"
													>
														Añade Servicios
													</a>
												</div>
											</div>
										)
									})}
								</article>

								<article
									id="tab-edit"
									class="tab-content hidden translate-y-2 divide-y divide-neutral-800 opacity-0 transition-all duration-300"
								>
									{userProducts.map((el) => {
										let type = null
										if (el.productType === "Hotel") type = "hotels"
										if (el.productType === "Tour") type = "tours"
										if (el.productType === "Package") type = "packages"
										return (
											<div class="items-center justify-between py-3 md:flex">
												<div class="mb-7 flex flex-col">
													<a href={`/${type}/${el.id}`}>
														<span class="text-xs font-medium text-neutral-100 md:text-sm">
															{el.name}
														</span>
													</a>
													<span class="hidden text-xs text-neutral-400 md:block">
														{el.productType}
													</span>
													<small class="text-xs text-neutral-400 md:hidden">{el.productType}</small>
												</div>

												<div class="flex items-center justify-end gap-6 text-xs font-medium text-neutral-300 md:text-sm">
													<a
														href={`/products/${el.id}/edit`}
														class="flex gap-1 text-neutral-500 hover:text-neutral-100"
													>
														<span class="hidden md:block">Editar</span> Producto
													</a>
													<a
														href={`/products/${el.id}/edit/images`}
														class="flex gap-1 text-neutral-500 hover:text-neutral-100"
													>
														<span class="hidden md:block">Editar</span> Imágenes
													</a>
													<a
														href={`/products/${el.id}/edit/subtype`}
														class="text-neutral-500 hover:text-neutral-100"
													>
														{`Detalles del ${el.productType}`}
													</a>

													<button
														data-product-id={el.id}
														class="delete-button text-red-500 hover:text-red-300"
														type="button"
													>
														Eliminar
													</button>
												</div>
											</div>
										)
									})}
								</article>

								<article
									id="tab-room"
									class="tab-content hidden translate-y-2 divide-y divide-neutral-800 opacity-0 transition-all duration-300"
								>
									{userProducts
										.filter((p) => p.productType === "Hotel")
										.map((el) => (
											<div class="items-center justify-between py-3 md:flex">
												<div class="mb-7 flex flex-col">
													<span class="text-xs font-medium text-neutral-100 md:text-sm">
														{el.name}
													</span>
													<span class="hidden text-xs text-neutral-400 md:block">
														{el.productType}
													</span>
													<small class="text-xs text-neutral-400 md:hidden">{el.productType}</small>
												</div>
												<div class="flex grid grid-cols-4 justify-end gap-4 text-xs font-medium text-neutral-300 md:grid-cols-5 lg:grid-cols-7">
													{!roomsByHotel[el.id] || roomsByHotel[el.id].length === 0
														? null
														: roomsByHotel[el.id].map((room) => {
																return (
																	<a
																		href={`/products/${el.id}/rooms/config`}
																		class="truncate text-neutral-500 hover:text-neutral-100"
																	>
																		{room.name}
																	</a>
																)
															})}
													<a
														href={`/products/${el.id}/rooms`}
														class="truncate text-xs text-green-400 hover:text-green-300 md:text-sm"
													>
														Añade Habitaciones
													</a>
												</div>
											</div>
										))}
								</article>
							</div>
						</section>
					)
				}
			</div>
		</main>
	</div>
	<script>
		const $deleteBtns = document.querySelectorAll(".delete-button")

		$deleteBtns.forEach((el) => {
			el.addEventListener("click", async (e) => {
				const button = e.currentTarget as HTMLButtonElement
				const productId = button.dataset.productId

				if (
					confirm(
						"¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer."
					)
				) {
					try {
						const res = await fetch(`/api/products/${productId}/delete`, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({ productId }),
						})
						if (res.ok) {
							window.location.reload()
						} else {
							const errorText = await res.text()
							alert(`Error al eliminar el producto: ${errorText}`)
						}
					} catch (e) {
						console.error("Error: ", e)
						alert("Hubo un error al procesar la solicitud.")
					}
				}
			})
		})
	</script>
	<script>
		const tabButtons = document.querySelectorAll(".tab-button") as NodeListOf<HTMLDivElement>
		const tabContents = document.querySelectorAll(".tab-content")

		tabButtons.forEach((btn) => {
			btn.addEventListener("click", () => {
				// quitar activo de todos
				tabButtons.forEach((b) =>
					b.classList.remove("active", "text-white", "border-b", "border-white")
				)
				tabContents.forEach((c) => c.classList.add("hidden"))

				// activar el actual
				btn.classList.add("active", "text-white", "border-b", "border-white")
				const content = document.querySelector(`#tab-${btn.dataset.tab}`)
				content?.classList.remove("hidden")
			})
		})
	</script>
	<script>
		// TAB switching + nice animation
		document.addEventListener("DOMContentLoaded", () => {
			const tabButtons = document.querySelectorAll(".tab-button")
			const contents = document.querySelectorAll(".tab-content")

			function showTab(name: string | undefined) {
				contents.forEach((c) => {
					c.classList.add("hidden")
					c.classList.add("opacity-0", "translate-y-2")
					c.classList.remove("opacity-100", "translate-y-0")
				})
				const id = "tab-" + name
				const el = document.getElementById(id)
				if (!el) return
				el.classList.remove("hidden")
				requestAnimationFrame(() => {
					el.classList.remove("opacity-0", "translate-y-2")
					el.classList.add("opacity-100", "translate-y-0")
				})
			}

			showTab("products")

			tabButtons.forEach((b) => {
				const btn = b as HTMLButtonElement
				btn.addEventListener("click", () => {
					tabButtons.forEach((b) =>
						b.classList.remove("active", "text-white", "border-b", "border-white")
					)
					btn.classList.add("active", "text-white", "border-b", "border-white")
					const target = btn.dataset.tab
					showTab(target)
				})
			})
		})
	</script>
</Layout>
