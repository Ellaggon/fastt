---
import Breadcrumbs from "@/components/Breadcrumbs.astro"
import ImageModal from "@/components/product/ImageModal.astro"
import MapClient from "@/components/product/MapClient.astro"
import { serviceIcons } from "@/data/service-icons"
import Layout from "@/layouts/Layout.astro"
import type { ImageRow, ServiceRow } from "@/types/products"
import {
	and,
	asc,
	db,
	desc,
	Destination,
	eq,
	Hotel,
	HotelRoomType,
	Image,
	inArray,
	Product,
	ProductService,
	Service,
} from "astro:db"

const productId = Astro.params.id
let product: any = null
let subtype: any = null
let images: ImageRow[] = []
let services: ServiceRow[] = []
let rooms = null
let roomImages = null
let errorMessage: string | null = null

try {
	if (!productId) throw new Error("ID de producto no proporcionado.")

	const productResult = await db
		.select()
		.from(Product)
		.leftJoin(Destination, eq(Destination.id, Product.destinationId))
		.where(eq(Product.id, productId))
		.get()

	if (!productResult) throw new Error("Producto no encontrado.")
	product = { ...productResult.Product, destination: productResult.Destination }

	const servicesResult = await db
		.select({ id: Service.id, name: Service.name })
		.from(ProductService)
		.leftJoin(Service, eq(ProductService.serviceId, Service.id))
		.where(eq(ProductService.productId, productId))
		.all()

	services = (servicesResult ?? []).filter((s) => s.id && s.name) as ServiceRow[]

	images = await db
		.select()
		.from(Image)
		.where(eq(Image.entityId, productId))
		.orderBy(desc(Image.isPrimary), asc(Image.order))
		.all()

	subtype = await db.select().from(Hotel).where(eq(Hotel.productId, productId)).get()

	rooms = await db.select().from(HotelRoomType).where(eq(HotelRoomType.hotelId, productId)).all()

	const roomIds = rooms.map((r) => r.id)
	roomImages = await db
		.select()
		.from(Image)
		.where(and(eq(Image.entityType, "HotelRoomType"), inArray(Image.entityId, roomIds)))
		.all()
} catch (e) {
	console.error("Error al obtener detalles del producto:", e)
	errorMessage = e instanceof Error ? e.message : "Error desconocido"
}

const roomsWithImages = rooms?.map((room) => ({
	...room,
	images: roomImages?.filter((img) => img.entityId === room.id),
}))
const productData = product
	? { ...product, images, subtype, services, rooms: roomsWithImages }
	: null
console.log("productData: ", productData)

const breadcrumbItems = [
	{ name: "Home", href: "/" },
	{
		name: productData?.productType ?? "",
		href:
			productData?.productType === "Hotel"
				? "/hotels"
				: productData?.productType === "Package"
					? "/packages"
					: "/tours",
	},
	{
		name: productData?.name || "/",
		href: `/products/${productId}`,
		current: true,
	},
]
---

<Layout title={productData?.name || "Producto"}>
	<main class="mx-auto min-h-screen w-[96%] max-w-7xl space-y-3 py-7 md:space-y-7 lg:p-12">
		<div class="hidden md:block">
			<Breadcrumbs items={breadcrumbItems} />
		</div>

		{
			errorMessage ? (
				<div class="flex min-h-[60vh] flex-col items-center justify-center text-center">
					<h1 class="mb-4 text-4xl font-bold text-red-500">{errorMessage}</h1>
					<a
						href="/"
						class="rounded-lg border border-gray-500 px-6 py-3 transition hover:bg-gray-800 hover:text-white"
					>
						Volver al inicio
					</a>
				</div>
			) : productData ? (
				<>
					{/* <!-- üñº Imagen principal --> */}
					<div class="relative overflow-hidden rounded-2xl shadow-lg">
						<img
							id="gallery-main-img"
							src={productData.images[0]?.url || "https://placehold.co/1200x675?text=Sin+imagen"}
							alt={productData.name}
							class="h-96 w-full cursor-pointer object-cover transition-transform duration-700 hover:scale-105"
						/>
					</div>

					{/* <!-- üñº Miniaturas --> */}
					{productData.images.length > 1 && (
						<div class="grid grid-cols-3 gap-2 sm:grid-cols-4 md:grid-cols-6">
							{productData.images.map((img: ImageRow, i: number) => (
								<img
									src={img.url}
									alt={`Imagen ${i + 1}`}
									class="thumb-img h-24 w-full cursor-pointer rounded-lg object-cover hover:opacity-80"
									data-index={i}
								/>
							))}
						</div>
					)}

					{/* <!-- üìã Info principal --> */}
					<section class="space-y-3 rounded-2xl border border-gray-200 bg-gray-100 p-3 shadow-sm md:p-8">
						<div class="flex gap-1 text-black">
							{Array.from({ length: productData.subtype?.stars || "" }).map((_, i) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									fill="currentColor"
									viewBox="0 0 24 24"
									class="h-5 w-5"
								>
									<path d="M12 .587l3.668 7.568L24 9.748l-6 5.85 1.416 8.252L12 19.771l-7.416 4.079L6 15.598 0 9.748l8.332-1.593z" />
								</svg>
							))}
						</div>
						<h1 class="text-lg font-semibold text-gray-900 md:text-4xl md:font-bold">
							{productData.name}
						</h1>
						<p class="text-xs text-neutral-500 md:text-sm">
							{productData.subtype?.address}, {productData.destination?.name}
						</p>
						{/* <!-- Servicios --> */}
						{productData.services.length > 0 && (
							<ul class="flex grid grid-cols-2 justify-start gap-3 py-10 md:grid-cols-3 lg:grid-cols-4">
								{productData.services.map((service: ServiceRow) => {
									const key = service.id?.toLowerCase() as keyof typeof serviceIcons
									const Icon = serviceIcons[key]
									return (
										<li class="flex h-[42px] max-w-56 items-center gap-2 p-2">
											{Icon ? <Icon class="h-5 w-5 shrink-0 text-black" /> : <span>‚Ä¢</span>}
											<span class="text-xs text-black md:text-sm">{service.name}</span>
										</li>
									)
								})}
							</ul>
						)}
						<p class="mt-4 text-sm leading-relaxed text-gray-700 md:text-base">
							{productData.description}
						</p>
					</section>

					<section class="grid grid-cols-2 p-3 md:p-8">
						<div>
							<p>
								<b>Check-in:</b> {productData.subtype?.checkInTime}
							</p>
							<p>
								<b>Check-out:</b> {productData.subtype?.checkOutTime}
							</p>
						</div>
						<div>
							<p>
								<b>$</b>
								{productData?.basePriceUSD}
							</p>
							<p>
								{productData?.basePriceBOB}
								<b>Bs</b>
							</p>
						</div>
					</section>

					{/* mapa */}
					<MapClient
						latitude={productData.subtype?.latitude}
						longitude={productData.subtype?.longitude}
						address={productData.subtype?.address || ""}
					/>
				</>
			) : (
				<p class="text-center text-gray-500">Cargando...</p>
			)
		}
	</main>
	{/* <!-- ü™ü Modal --> */}
	<ImageModal />
	<section class="mt-10 space-y-8">
		<h2 class="text-2xl font-bold text-gray-900">Habitaciones</h2>

		{
			productData.rooms?.map((room: any) => (
				<div class="rounded-xl border bg-white p-4 shadow-sm">
					<h3 class="text-xl font-semibold">{room.name}</h3>

					{/* Descripci√≥n */}
					<p class="mt-2 text-gray-700">{room.description || "Sin descripci√≥n"}</p>

					{/* Galer√≠a de im√°genes */}
					{room.images?.length > 0 ? (
						<div class="mt-4 grid grid-cols-2 gap-3 md:grid-cols-4">
							{room.images.map((img: any) => (
								<img
									src={img.url}
									alt={img.altText || room.name}
									class="h-32 w-full rounded-lg object-cover"
								/>
							))}
						</div>
					) : (
						<p class="mt-3 text-sm text-gray-400">No hay im√°genes para esta habitaci√≥n.</p>
					)}
				</div>
			))
		}
	</section>
</Layout>
