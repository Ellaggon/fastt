---
import Breadcrumbs from "@/components/Breadcrumbs.astro"
import ImageModal from "@/components/product/ImageModal.astro"
import MapModal from "@/components/product/MapModal.astro"
import RoomModal from "@/components/product/RoomModal.astro"
import { formatBedType } from "@/data/room-beds"
import { serviceIcons } from "@/data/service-icons"
import Layout from "@/layouts/Layout.astro"
import type { ImageRow, ServiceRow } from "@/types/products"
import {
	AmenityRoom,
	and,
	asc,
	db,
	desc,
	Destination,
	eq,
	Hotel,
	HotelRoomAmenity,
	HotelRoomType,
	Image,
	inArray,
	Product,
	ProductService,
	Service,
} from "astro:db"

const productId = Astro.params.id
let product: any = null
let subtype: any = null
let images: ImageRow[] = []
let services: ServiceRow[] = []
let rooms = null
let roomImages = null
let roomAmenities = null
let errorMessage: string | null = null

try {
	if (!productId) throw new Error("ID de producto no proporcionado.")
	const productResult = await db
		.select()
		.from(Product)
		.leftJoin(Destination, eq(Destination.id, Product.destinationId))
		.where(eq(Product.id, productId))
		.get()
	if (!productResult) throw new Error("Producto no encontrado.")
	product = { ...productResult.Product, destination: productResult.Destination }

	const servicesResult = await db
		.select({ id: Service.id, name: Service.name })
		.from(ProductService)
		.leftJoin(Service, eq(ProductService.serviceId, Service.id))
		.where(eq(ProductService.productId, productId))
		.all()
	services = (servicesResult ?? []).filter((s) => s.id && s.name) as ServiceRow[]

	images = await db
		.select()
		.from(Image)
		.where(eq(Image.entityId, productId))
		.orderBy(desc(Image.isPrimary), asc(Image.order))
		.all()

	subtype = await db.select().from(Hotel).where(eq(Hotel.productId, productId)).get()

	rooms = await db.select().from(HotelRoomType).where(eq(HotelRoomType.hotelId, productId)).all()
	const roomIds = rooms.map((r) => r.id)

	roomImages = await db
		.select()
		.from(Image)
		.where(and(eq(Image.entityType, "HotelRoomType"), inArray(Image.entityId, roomIds)))
		.all()

	roomAmenities = await db
		.select({
			roomId: HotelRoomAmenity.hotelRoomTypeId,
			amenityId: AmenityRoom.id,
			amenityName: AmenityRoom.name,
			category: AmenityRoom.category,
			isAvailable: HotelRoomAmenity.isAvailable,
		})
		.from(HotelRoomAmenity)
		.leftJoin(AmenityRoom, eq(HotelRoomAmenity.amenityId, AmenityRoom.id))
		.where(inArray(HotelRoomAmenity.hotelRoomTypeId, roomIds))
		.all()
} catch (e) {
	console.error("Error al obtener detalles del producto:", e)
	errorMessage = e instanceof Error ? e.message : "Error desconocido"
}
//Rooms
const roomsServer =
	rooms?.map((room) => ({
		...room,
		images: roomImages?.filter((img) => img.entityId === room.id) ?? [],
		amenities: roomAmenities?.filter((a) => a.roomId === room.id) ?? [],
	})) ?? []

//AmenityRooms
console.log("roomAmenity", roomAmenities)
const productData = product ? { ...product, images, subtype, services, rooms: roomsServer } : null
console.log("productData: ", productData)

const breadcrumbItems = [
	{ name: "Home", href: "/" },
	{
		name: productData?.productType ?? "",
		href:
			productData?.productType === "Hotel"
				? "/hotels"
				: productData?.productType === "Package"
					? "/packages"
					: "/tours",
	},
	{
		name: productData?.name || "/",
		href: `/products/${productId}`,
		current: true,
	},
]
---

<Layout title={productData?.name || "Producto"}>
	<main class="mx-auto min-h-screen w-[96%] max-w-7xl space-y-3 py-7 md:space-y-7 lg:p-12">
		<Breadcrumbs items={breadcrumbItems} />

		{
			errorMessage ? (
				<div class="flex min-h-[60vh] flex-col items-center justify-center text-center">
					<h1 class="mb-4 text-4xl font-bold text-red-500">{errorMessage}</h1>
					<a
						href="/"
						class="rounded-lg border border-neutral-500 px-6 py-3 transition hover:bg-neutral-800 hover:text-white"
					>
						Volver al inicio
					</a>
				</div>
			) : productData ? (
				<>
					{/* <!-- üñº Imagen principal --> */}
					<div class="relative overflow-hidden rounded-2xl shadow-lg">
						<img
							id="gallery-main-img"
							src={productData.images[0]?.url || "https://placehold.co/1200x675?text=Sin+imagen"}
							alt={productData.name}
							class="h-96 w-full cursor-pointer object-cover transition-transform duration-700 hover:scale-105"
						/>
					</div>

					{/* <!-- üñº Miniaturas --> */}
					{productData.images.length > 1 && (
						<div class="grid grid-cols-3 gap-2 sm:grid-cols-4 md:grid-cols-6">
							{productData.images.map((img: ImageRow, i: number) => (
								<img
									src={img.url}
									alt={`Imagen ${i + 1}`}
									class="thumb-img h-24 w-full cursor-pointer rounded-lg object-cover hover:opacity-80"
									data-index={i}
								/>
							))}
						</div>
					)}

					{/* <!-- üìã Info principal --> */}
					<section class="space-y-3 rounded-2xl bg-neutral-100 p-3 shadow-sm md:p-8">
						<div class="flex gap-1 text-black">
							{Array.from({ length: productData.subtype?.stars || "" }).map((_, i) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									fill="currentColor"
									viewBox="0 0 24 24"
									class="h-5 w-5"
								>
									<path d="M12 .587l3.668 7.568L24 9.748l-6 5.85 1.416 8.252L12 19.771l-7.416 4.079L6 15.598 0 9.748l8.332-1.593z" />
								</svg>
							))}
						</div>
						<h1 class="text-lg font-semibold text-neutral-900 md:text-4xl md:font-bold">
							{productData.name}
						</h1>
						<p class="text-xs text-neutral-500 md:text-sm">
							{productData.subtype?.address}, {productData.destination?.name}
						</p>
						{/* <!-- Servicios --> */}
						{productData.services.length > 0 && (
							<ul class="flex grid grid-cols-2 justify-start gap-3 py-10 md:grid-cols-3 lg:grid-cols-4">
								{productData.services.map((service: ServiceRow) => {
									const key = service.id?.toLowerCase() as keyof typeof serviceIcons
									const Icon = serviceIcons[key]
									return (
										<li class="flex h-[42px] max-w-56 items-center gap-2 p-2">
											{Icon ? <Icon class="h-5 w-5 shrink-0 text-black" /> : <span>‚Ä¢</span>}
											<span class="text-xs text-black md:text-sm">{service.name}</span>
										</li>
									)
								})}
							</ul>
						)}
						<p class="mt-4 text-sm leading-relaxed text-neutral-700 md:text-base">
							{productData.description}
						</p>
					</section>

					<section class="grid grid-cols-2 p-3 md:p-8">
						<div>
							<p>
								<b>Check-in:</b> {productData.subtype?.checkInTime}
							</p>
							<p>
								<b>Check-out:</b> {productData.subtype?.checkOutTime}
							</p>
						</div>
						<div>
							<p>
								<b>$</b>
								{productData?.basePriceUSD}
							</p>
							<p>
								{productData?.basePriceBOB}
								<b>Bs</b>
							</p>
						</div>
					</section>
					<button
						onclick="openMapModal()"
						class="rounded-lg bg-blue-600 px-4 py-2 text-white shadow hover:bg-blue-700"
					>
						Ver mapa
					</button>
				</>
			) : (
				<p class="text-center text-neutral-500">Cargando...</p>
			)
		}

		<section class="py-6">
			<div class="mx-auto max-w-7xl px-4">
				<header class="mb-6 flex items-end justify-between">
					<h2 class="text-lg font-semibold text-neutral-800">
						<span class="block text-xs text-neutral-400">Secci√≥n</span>
						<span class="-mt-1 block text-2xl font-semibold">Habitaciones</span>
					</h2>
					<p class="text-sm text-neutral-500">Selecciona la habitaci√≥n para ver detalles</p>
				</header>

				<div class="relative -mx-4 overflow-x-auto px-4 py-6">
					<div class="flex snap-x snap-mandatory gap-6">
						{
							(productData?.rooms ?? []).map((room: any) => {
								const lastImg =
									room.images && room.images.length ? room.images[room.images.length - 1] : null
								const thumb = lastImg?.url ?? "https://placehold.co/800x600?text=Sin+imagen"
								return (
									<article
										class="w-[320px] flex-shrink-0 snap-start rounded-3xl border border-neutral-100 bg-white/80 p-4 shadow-[0_12px_30px_rgba(10,10,10,0.08)] backdrop-blur-sm md:w-[360px] lg:w-[420px]"
										role="group"
										aria-labelledby={`room-${room.id}-title`}
									>
										<div class="relative h-48 w-full overflow-hidden rounded-2xl">
											<img
												src={thumb}
												alt={lastImg?.altText ?? room.name}
												class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
											/>
											{room.images && room.images.length > 1 && (
												<div class="absolute left-3 top-3 rounded-full bg-black/55 px-3 py-1 text-xs text-white">
													{room.images.length} fotos
												</div>
											)}
										</div>

										<div class="mt-4 flex items-start justify-between gap-3">
											<div>
												<h3
													id={`room-${room.id}-title`}
													class="text-lg font-semibold text-neutral-900"
												>
													{room.name}
												</h3>
												<p class="mt-1 text-sm text-neutral-500">
													{room.sizeM2 ? `${room.sizeM2} m¬≤` : ""}{" "}
													{room.hasView ? `‚Ä¢ ${room.hasView}` : ""}
												</p>
											</div>

											<div class="text-right">
												<p class="text-sm text-neutral-500">Desde</p>
												<p class="mt-1 text-base font-semibold text-neutral-900">
													${room.priceUSD ?? "--"}
												</p>
											</div>
										</div>

										<div class="mt-4 grid grid-cols-2 gap-3 text-sm text-neutral-600">
											<div class="flex items-center gap-2">
												{/* <!-- icono cama --> */}
												<svg
													class="h-5 w-5 text-neutral-500"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
												>
													<path
														d="M3 7h18v10H3V7Z"
														stroke-width="1.2"
														stroke-linecap="round"
														stroke-linejoin="round"
													/>
													<path
														d="M5 10v4"
														stroke-width="1.2"
														stroke-linecap="round"
														stroke-linejoin="round"
													/>
													<path
														d="M19 10v4"
														stroke-width="1.2"
														stroke-linecap="round"
														stroke-linejoin="round"
													/>
												</svg>
												<span>{formatBedType(room.bedType)}</span>
											</div>

											<div class="flex items-center gap-2">
												<svg
													class="h-5 w-5 text-neutral-500"
													viewBox="0 0 24 24"
													fill="currentColor"
												>
													<path d="M7 2h10v2H7V2Zm5 4a5 5 0 0 1 5 5v6h-2v5h-2v-5h-2v5H9v-5H7v-6a5 5 0 0 1 5-5Z" />
												</svg>
												<span>{room.bathroom ?? "‚Äî"} ba√±os</span>
											</div>

											<div class="flex items-center gap-2">
												<svg
													class="h-5 w-5 text-neutral-500"
													viewBox="0 0 24 24"
													fill="currentColor"
												>
													<path d="M3 10h18v2H3v-2Z" />
												</svg>
												<span>{room.hasBalcony ? "Con balc√≥n" : "Sin balc√≥n"}</span>
											</div>

											<div class="flex items-center gap-2">
												<svg
													class="h-5 w-5 text-neutral-500"
													viewBox="0 0 24 24"
													fill="currentColor"
												>
													<path d="M3 6h18v8H3V6Z" />
												</svg>
												<span>Capacidad: {room.maxOccupancyOverride ?? "--"}</span>
											</div>
										</div>

										<div class="mt-5 flex items-center justify-between gap-3">
											<button
												class="flex-1 rounded-md border border-neutral-200 bg-white px-3 py-2 text-sm font-medium text-neutral-700 hover:shadow-md"
												type="button"
												data-room-id={room.id}
											>
												Ver habitaci√≥n
											</button>

											<a
												class="ml-3 inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700"
												href={`/book/${room.id}`}
											>
												Reservar
											</a>
										</div>
									</article>
								)
							})
						}
					</div>
				</div>
			</div>

			<!-- contenedor con JSON en data-attribute (seguro) -->
			<div id="rooms-data" data-rooms={JSON.stringify(roomsServer || [])} class="hidden"></div>
		</section>
	</main>
	<ImageModal />
	<MapModal
		latitude={productData.subtype?.latitude}
		longitude={productData.subtype?.longitude}
		address={productData.subtype?.address || ""}
	/>
	<RoomModal />
</Layout>
