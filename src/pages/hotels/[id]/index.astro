---
import ImageModal from "@/components/product/ImageModal.astro"
import MapModal from "@/components/product/MapModal.astro"
import BreadcrumProduct from "@/components/productUI/BreadcrumProduct.astro"
import RoomModal from "@/components/productUI/RoomModal.astro"
import RoomSection from "@/components/productUI/RoomSection.astro"
import { serviceIcons } from "@/data/service/service-icons"
import Layout from "@/layouts/Layout.astro"
import type { ImageRow, ServiceRow } from "@/types/products"
import {
	AmenityRoom,
	and,
	asc,
	db,
	desc,
	Destination,
	eq,
	Hotel,
	HotelRoomAmenity,
	HotelRoomType,
	Image,
	inArray,
	Product,
	ProductService,
	Service,
	Variant,
} from "astro:db"

const productId = Astro.params.id
const url = Astro.url

let product: any = null
let subtype: any = null
let images: ImageRow[] = []
let services: ServiceRow[] = []
let rooms = null
let roomImages = null
let roomAmenities = null
let roomVariants = null
let errorMessage: string | null = null

const searchState = {
	checkIn: url.searchParams.get("checkin"),
	checkOut: url.searchParams.get("checkout"),
	adults: Number(url.searchParams.get("adults") ?? 2),
	children: Number(url.searchParams.get("children") ?? 0),
}

try {
	if (!productId) throw new Error("ID de producto no proporcionado.")
	const productResult = await db
		.select()
		.from(Product)
		.leftJoin(Destination, eq(Destination.id, Product.destinationId))
		.where(eq(Product.id, productId))
		.get()
	if (!productResult) throw new Error("Producto no encontrado.")
	product = { ...productResult.Product, destination: productResult.Destination }

	const servicesResult = await db
		.select({ id: Service.id, name: Service.name })
		.from(ProductService)
		.leftJoin(Service, eq(ProductService.serviceId, Service.id))
		.where(eq(ProductService.productId, productId))
		.all()
	services = (servicesResult ?? []).filter((s) => s.id && s.name) as ServiceRow[]
	console.log("service: ", services)

	images = await db
		.select()
		.from(Image)
		.where(eq(Image.entityId, productId))
		.orderBy(desc(Image.isPrimary), asc(Image.order))
		.all()

	subtype = await db.select().from(Hotel).where(eq(Hotel.productId, productId)).get()

	rooms = await db.select().from(HotelRoomType).where(eq(HotelRoomType.hotelId, productId)).all()
	const roomIds = rooms.map((r) => r.id)

	roomImages = await db
		.select()
		.from(Image)
		.where(and(eq(Image.entityType, "HotelRoomType"), inArray(Image.entityId, roomIds)))
		.all()

	roomAmenities = await db
		.select({
			roomId: HotelRoomAmenity.hotelRoomTypeId,
			amenityId: AmenityRoom.id,
			amenityName: AmenityRoom.name,
			category: AmenityRoom.category,
			isAvailable: HotelRoomAmenity.isAvailable,
		})
		.from(HotelRoomAmenity)
		.leftJoin(AmenityRoom, eq(HotelRoomAmenity.amenityId, AmenityRoom.id))
		.where(inArray(HotelRoomAmenity.hotelRoomTypeId, roomIds))
		.all()

	roomVariants = await db
		.select({
			id: Variant.id,
			entityId: Variant.entityId,
			name: Variant.name,
			description: Variant.description,
		})
		.from(Variant)
		.where(and(eq(Variant.entityType, "hotel_room"), inArray(Variant.entityId, roomIds)))
		.all()
} catch (e) {
	console.error("Error al obtener detalles del producto:", e)
	errorMessage = e instanceof Error ? e.message : "Error desconocido"
}
//Rooms
const roomsServer =
	rooms?.map((room) => ({
		...room,
		images: roomImages?.filter((img) => img.entityId === room.id) ?? [],
		amenities: roomAmenities?.filter((a) => a.roomId === room.id) ?? [],
		variant: roomVariants?.filter((v) => v.entityId === room.id) ?? [],
	})) ?? []

const productData = product ? { ...product, images, subtype, services, rooms: roomsServer } : null

console.log("productData: ", productData.services)
---

<Layout title={productData?.name || "Producto"}>
	<main class="mx-auto min-h-screen w-[96%] max-w-7xl space-y-3 py-7 md:space-y-7 lg:p-12">
		<BreadcrumProduct productData={productData} productId={productId} />

		{
			errorMessage ? (
				<div class="flex min-h-[60vh] flex-col items-center justify-center text-center">
					<h1 class="mb-4 text-4xl font-bold text-red-500">{errorMessage}</h1>
					<a
						href="/"
						class="rounded-lg border border-neutral-500 px-6 py-3 transition hover:bg-neutral-800 hover:text-white"
					>
						Volver al inicio
					</a>
				</div>
			) : productData ? (
				<>
					{/* <!-- ðŸ–¼ Imagen principal --> */}
					<div class="relative overflow-hidden rounded-2xl shadow-lg">
						<img
							id="gallery-main-img"
							src={productData.images[0]?.url || "https://placehold.co/1200x675?text=Sin+imagen"}
							alt={productData.name}
							class="h-96 w-full cursor-pointer object-cover transition-transform duration-700 hover:scale-105"
						/>
					</div>

					{/* <!-- ðŸ–¼ Miniaturas --> */}
					{productData.images.length > 1 && (
						<div class="grid grid-cols-3 gap-2 sm:grid-cols-4 md:grid-cols-6">
							{productData.images.map((img: ImageRow, i: number) => (
								<img
									src={img.url}
									alt={`Imagen ${i + 1}`}
									class="thumb-img h-24 w-full cursor-pointer rounded-lg object-cover hover:opacity-80"
									data-index={i}
								/>
							))}
						</div>
					)}

					{/* <!-- ðŸ“‹ Info principal --> */}
					<section class="space-y-3 rounded-2xl bg-neutral-100 p-3 shadow-sm md:p-8">
						<div class="flex gap-1 text-black">
							{Array.from({ length: productData.subtype?.stars || "" }).map((_, i) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									fill="currentColor"
									viewBox="0 0 24 24"
									class="h-5 w-5"
								>
									<path d="M12 .587l3.668 7.568L24 9.748l-6 5.85 1.416 8.252L12 19.771l-7.416 4.079L6 15.598 0 9.748l8.332-1.593z" />
								</svg>
							))}
						</div>
						<h1 class="text-lg font-semibold text-neutral-900 md:text-4xl md:font-bold">
							{productData.name}
						</h1>
						<p class="text-xs text-neutral-500 md:text-sm">
							{productData.subtype?.address}, {productData.destination?.name}
						</p>
						{/* <!-- Servicios --> */}
						{productData.services.length > 0 && (
							<ul class="flex grid grid-cols-2 justify-start gap-3 py-10 md:grid-cols-3 lg:grid-cols-4">
								{productData.services.map((service: ServiceRow) => {
									console.log("service: ", service)
									const key = service.id?.toLowerCase() as keyof typeof serviceIcons
									const Icon = serviceIcons[key]
									return (
										<li class="flex h-[42px] max-w-56 items-center gap-2 p-2">
											{Icon ? <Icon class="h-5 w-5 shrink-0 text-black" /> : <span>â€¢</span>}
											<span class="text-xs text-black md:text-sm">{service.name}</span>
										</li>
									)
								})}
							</ul>
						)}
						<p class="mt-4 text-sm leading-relaxed text-neutral-700 md:text-base">
							{productData.description}
						</p>
					</section>

					<section class="space-y-3 rounded-2xl bg-neutral-100 p-3 shadow-sm md:p-8" />
					<button
						onclick="openMapModal()"
						class="rounded-lg bg-blue-600 px-4 py-2 text-white shadow hover:bg-blue-700"
					>
						Ver mapa
					</button>
				</>
			) : (
				<p class="text-center text-neutral-500">Cargando...</p>
			)
		}

		<section class="py-6">
			<div class="mx-auto max-w-7xl px-4">
				<RoomSection rooms={productData.rooms} searchState={searchState} />
			</div>

			<div id="rooms-data" data-rooms={JSON.stringify(roomsServer || [])} class="hidden"></div>
		</section>
	</main>
	<ImageModal />
	<MapModal
		latitude={productData.subtype?.latitude}
		longitude={productData.subtype?.longitude}
		address={productData.subtype?.address || ""}
	/>
	<RoomModal productId={productId} searchState={searchState} />
</Layout>
