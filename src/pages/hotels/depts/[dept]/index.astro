---
import Breadcrumbs from "@/components/Breadcrumbs.astro"
import ProductCard from "@/components/product/ProductCard.astro"
import { DEPARTMENTS } from "@/data/departments"
import SearchLayout from "@/layouts/SearchLayout.astro"
import { and, db, eq, Hotel, Image, Product, ProductService, Service, sql } from "astro:db"

const deptId = Astro.params.dept || null
if (!deptId) throw new Error("Departamento no especificado")

let hotels: any[] = []
let depts = null

try {
	depts = DEPARTMENTS.find((d) => d.id === deptId)
	if (!depts) {
		throw new Error("Departamento no exncontrado")
	}

	hotels = await db
		.select({
			id: Product.id,
			name: Product.name,
			imageUrl: sql`(
				SELECT url 
				FROM Image 
				WHERE entityId = ${Product.id}
				ORDER BY isPrimary DESC, "order" ASC
				LIMIT 1
			)`.as("imageUrl"),
			shortDescription: Product.shortDescription,
			basePriceUSD: Product.basePriceUSD,
			basePriceBOB: Product.basePriceBOB,
			address: Hotel.address,
			stars: Hotel.stars,
			services: sql`(
				SELECT json_group_array(
					json_object(
						'id', s.id,
						'name', s.name
					)
				)
				FROM ProductService ps 
				JOIN Service s ON s.id = ps.serviceId
				WHERE ps.productId = ${Product.id}
			)`.as("services"),
		})
		.from(Product)
		.leftJoin(Image, eq(Image.entityId, Product.id))
		.leftJoin(Hotel, eq(Hotel.productId, Product.id))
		.leftJoin(ProductService, eq(ProductService.productId, Product.id))
		.leftJoin(Service, eq(ProductService.serviceId, Service.id))
		.where(and(eq(Product.productType, "Hotel"), eq(Product.departmentId, deptId)))
		.groupBy(Product.id)
		.all()
	console.log("product: ", hotels)
} catch (e) {
	console.error(e)
}

// Datos de hoteles simulados (idealmente vendrían de una API o CMS)
// He limpiado los datos innecesarios (data-id, data-codigo, lat/lng, etc.)
// y simplificado los servicios para facilitar su manejo.
const hotelsData = [
	{
		name: "Hotel Eurotel Providencia",
		href: "/es/santiago/hotel-eurotel-providencia.htm",
		image: "https://picsum.photos/id/10/400/250", // Random image
		alt: "Hotel Eurotel Providencia",
		stars: 4,
		address: "Guardia Vieja 285, Providencia, Santiago",
		description:
			"Hotel Eurotel es un hotel cuatro estrellas recientemente renovado con un estilo europeo, ubicado en un área residencial del nuevo centro de Santiago cercano a 2 estaciones del metro, las principales calles y pubs.",
		priceUSD: 106,
		priceCLP: 80325,
		services: [
			{ name: "Estacionamiento", available: true },
			{ name: "Gimnasio", available: true },
			{ name: "Restaurante", available: false },
			{ name: "Bar", available: false },
			{ name: "Piscina", available: false },
			{ name: "Aire Acondicionado", available: false },
			{ name: "SPA", available: false },
			{ name: "Internet - Habitación", available: false },
			{ name: "Internet - Wi-Fi", available: false },
		],
	},
	{
		name: "Hotel Providencia",
		href: "/es/santiago/hotel-providencia.htm",
		image: "https://picsum.photos/id/20/400/250",
		alt: "Hotel Providencia",
		stars: 4,
		address: "Calle Francisco Noguera 146, Providencia, Santiago",
		description:
			"De avanzada arquitectura y excelente ubicación, dispone de 66 habitaciones climatizadas. Bar, restaurant, room service, piscina y business centre las 24 hrs. Salas de reuniones hasta 100 personas. Estacionamiento privado.",
		priceUSD: 106,
		priceCLP: 83300,
		services: [
			{ name: "Estacionamiento", available: true },
			{ name: "Piscina", available: true },
			{ name: "Restaurante", available: false },
			{ name: "Gimnasio", available: false },
			{ name: "Bar", available: false },
			{ name: "Aire Acondicionado", available: false },
			{ name: "SPA", available: false },
			{ name: "Internet - Habitación", available: false },
			{ name: "Internet - Wi-Fi", available: false },
		],
	},
	{
		name: "Apart Hotel Neruda",
		href: "/es/santiago/apart-hotel-neruda.htm",
		image: "https://picsum.photos/id/30/400/250",
		alt: "Apart Hotel Neruda",
		stars: 0, // No stars in original, set to 0
		address: "Avda Pedro de Valdivia 164, Providencia, Santiago",
		description:
			"Ubicado en el tradicional Barrio Providencia de la ciudad de Santiago, a solo pasos del metro y de las principales avenidas. Cuenta con departamento amoblados y equipados que ofrecen a sus visitantes…",
		priceUSD: 110,
		priceCLP: 69913,
		services: [
			{ name: "Estacionamiento", available: true },
			{ name: "Gimnasio", available: true },
			{ name: "Piscina", available: true },
			{ name: "Restaurante", available: false },
			{ name: "Bar", available: false },
			{ name: "Aire Acondicionado", available: false },
			{ name: "SPA", available: false },
			{ name: "Internet - Habitación", available: false },
			{ name: "Internet - Wi-Fi", available: false },
		],
	},
	{
		name: "Hotel Panamericano",
		href: "/es/santiago/hotel-panamericano.htm",
		image: "https://picsum.photos/id/180/400/250",
		alt: "Hotel Panamericano",
		stars: 3,
		address: "Teatinos 320, Santiago",
		description:
			"Ubicado en el corazón del centro de Santiago, a pasos del palacio de gobierno, una de las zonas mas seguras de la capital, en lo que constituye el núcleo financiero, cultural, cívico y comercial del país.",
		services: [], // No services in original, set to empty array
	},
]

const breadcrumbItems = [
	{ name: "Home", href: "/" },
	{ name: "Hoteles", href: "/hotels" },
	{ name: `${depts?.name}`, href: `/hotels/${depts?.id}`, current: true },
]
---

<SearchLayout title={`Hoteles en ${deptId}`} producType="hotels">
	<div class="flex grid grid-cols-4 justify-center">
		<aside class="col-span-1 m-7 hidden rounded-lg border md:flex"></aside>
		<main
			role="main"
			id="content"
			class="col-span-4 mx-auto my-3 max-w-7xl px-4 pt-3 sm:px-6 md:col-span-3 md:pt-10 lg:px-5 xl:col-span-2 xl:pt-10"
		>
			<Breadcrumbs items={breadcrumbItems} />

			<div class="mt-8 hidden md:block">
				<p class="mb-6 text-lg text-neutral-500">
					Encuentra el alojamiento que necesitas y compáralo con otros en nuestra guía de hoteles de
					{depts?.name}. Si lo que buscas es más información del destino, te invitamos a ver nuestra <a
						href={`/hotels/${depts?.id}/`}
						class="text-white hover:underline">Guía de {depts?.name}</a
					>.
				</p>
			</div>

			<div class="grid grid-cols-1 gap-6">
				{hotelsData.map((hotel) => <ProductCard {...hotel} />)}
				{
					hotels.length > 0 ? (
						hotels.map((h) => (
							<ProductCard
								name={h.name}
								href={`/hotels/${h.id}`}
								image={h.imageUrl || "https://picsum.photos/400/250"}
								alt={h.name}
								stars={h.stars || 0}
								address={h.address || "Dirección no disponible"}
								description={h.shortDescription || ""}
								priceUSD={h.basePriceUSD || 0}
								priceBOB={h.basePriceBOB || 0}
								services={JSON.parse(h.services) || []}
							/>
						))
					) : (
						<p class="col-span-full text-center text-gray-500">No se encontraron hoteles.</p>
					)
				}
			</div>
		</main>
	</div>
</SearchLayout>
